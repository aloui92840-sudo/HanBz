<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HanBz - Plateforme Éducative Tunisienne</title>
    <meta name="description" content="HanBz - Plateforme Éducative Tunisienne pour enseignants et élèves">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --teacher-color: #9b59b6;
            --student-color: #2ecc71;
            --admin-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-bg: #f8f9fa;
            --card-shadow: 0 8px 30px rgba(0,0,0,0.12);
            --hover-shadow: 0 15px 40px rgba(0,0,0,0.15);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo i {
            margin-right: 12px;
            font-size: 32px;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 40px 0;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
            background: #f1f3f5;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 18px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .auth-tab.active {
            background: white;
            color: var(--primary-color);
        }

        .auth-tab:not(.active):hover {
            background: #e9ecef;
        }

        .auth-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-teacher {
            background: linear-gradient(135deg, var(--teacher-color), #8e44ad);
            color: white;
        }

        .btn-student {
            background: linear-gradient(135deg, var(--student-color), #27ae60);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--admin-color), #c0392b);
            color: white;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 600px;
        }

        .hidden {
            display: none !important;
        }

        .role-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: .85em;
            font-weight: 600;
        }

        .badge-admin {
            background: linear-gradient(135deg, var(--admin-color), #c0392b);
            color: white;
        }

        .badge-teacher {
            background: linear-gradient(135deg, var(--teacher-color), #8e44ad);
            color: white;
        }

        .badge-student {
            background: linear-gradient(135deg, var(--student-color), #27ae60);
            color: white;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .stat-card p {
            color: var(--dark-color);
            font-weight: 500;
        }

        .students-grid, .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .student-card, .class-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .student-card:hover, .class-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 520px;
            padding: 30px;
            position: relative;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--dark-color);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            gap: 10px;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .sidebar-menu i {
            width: 20px;
            text-align: center;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .alert-warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--card-shadow);
            animation: slideIn 0.3s ease;
        }

        .alert-toast.success {
            background: var(--success-color);
        }

        .alert-toast.danger {
            background: var(--danger-color);
        }

        .alert-toast.warning {
            background: var(--warning-color);
        }

        .file-item {
            padding: 15px;
            background: white;
            margin: 10px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--success-color);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
            width: 0%;
        }

        .message-item {
            padding: 15px;
            background: white;
            margin: 10px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .message-sender {
            font-weight: bold;
            color: var(--primary-color);
        }

        .message-time {
            color: #666;
            font-size: 0.9em;
        }

        .course-content {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }

        .lesson-item {
            padding: 15px;
            background: #f8f9fa;
            margin: 10px 0;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                margin-bottom: 20px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Section d'authentification -->
    <div id="authSection">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo"><i class="fas fa-graduation-cap"></i> HanBz.tn</div>
                    <div><span style="color:var(--dark-color);font-weight:500;">Plateforme Éducative Tunisienne</span></div>
                </div>
            </div>
        </div>
        
        <div class="container auth-container">
            <div class="auth-form">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="showAuthTab('login')">Connexion</div>
                    <div class="auth-tab" onclick="showAuthTab('teacher')">Enseignant</div>
                    <div class="auth-tab" onclick="showAuthTab('student')">Élève</div>
                </div>

                <!-- Formulaire de connexion -->
                <div id="loginForm">
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="loginEmail" placeholder="votre@email.com" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Mot de passe</label>
                        <input type="password" id="loginPassword" placeholder="Votre mot de passe" required>
                    </div>
                    <button class="btn btn-primary" onclick="login()" style="width:100%">
                        <i class="fas fa-sign-in-alt"></i> Se connecter
                    </button>
                </div>

                <!-- Formulaire d'inscription enseignant -->
                <div id="teacherForm" class="hidden">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Nom complet</label>
                        <input type="text" id="teacherName" placeholder="Votre nom complet" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="teacherEmail" placeholder="votre@email.com" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Mot de passe</label>
                        <input type="password" id="teacherPassword" placeholder="Créez un mot de passe" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-graduation-cap"></i> Spécialité</label>
                        <input type="text" id="teacherSpecialty" placeholder="Votre domaine d'expertise" required>
                    </div>
                    <button class="btn btn-teacher" onclick="registerTeacher()" style="width:100%">
                        <i class="fas fa-chalkboard-teacher"></i> S'inscrire comme Enseignant
                    </button>
                </div>

                <!-- Formulaire d'inscription élève -->
                <div id="studentForm" class="hidden">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Nom complet</label>
                        <input type="text" id="studentName" placeholder="Votre nom complet" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="studentEmail" placeholder="votre@email.com" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Mot de passe</label>
                        <input type="password" id="studentPassword" placeholder="Créez un mot de passe" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-laptop-code"></i> Classe souhaitée</label>
                        <select id="studentClass" required>
                            <option value="">Sélectionnez une classe</option>
                            <option value="4ème Informatique">4ème Informatique</option>
                            <option value="3ème Programmation">3ème Programmation</option>
                            <option value="2ème Mathématiques">2ème Mathématiques</option>
                            <option value="1ère Sciences">1ère Sciences</option>
                        </select>
                    </div>
                    <button class="btn btn-student" onclick="registerStudent()" style="width:100%">
                        <i class="fas fa-user-graduate"></i> S'inscrire comme Élève
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Section application -->
    <div id="appSection" class="hidden">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo"><i class="fas fa-graduation-cap"></i> HanBz.tn</div>
                    <div class="user-actions">
                        <span id="userRoleBadge" class="role-badge"></span>
                        <span id="userNameDisplay" style="font-weight:500;color:var(--dark-color)"></span>
                        <button class="btn btn-primary" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Déconnexion
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container app-container">
            <aside class="sidebar">
                <h3 style="margin-bottom:25px;color:var(--dark-color);border-bottom:2px solid #e1e8ed;padding-bottom:15px">Navigation</h3>
                <ul class="sidebar-menu">
                    <li><a href="#" class="active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Tableau de bord</a></li>
                    <div id="teacherMenu" class="hidden">
                        <li><a href="#" onclick="showSection('students')"><i class="fas fa-users"></i> Gestion des élèves</a></li>
                        <li><a href="#" onclick="showSection('classes')"><i class="fas fa-book"></i> Gestion des classes</a></li>
                        <li><a href="#" onclick="showSection('pending')"><i class="fas fa-user-check"></i> Validations</a></li>
                    </div>
                    <div id="adminMenu" class="hidden">
                        <li><a href="#" onclick="showSection('admin')"><i class="fas fa-cogs"></i> Administration</a></li>
                        <li><a href="#" onclick="showSection('users')"><i class="fas fa-user-cog"></i> Gestion des utilisateurs</a></li>
                    </div>
                    <li><a href="#" onclick="showSection('messages')"><i class="fas fa-comments"></i> Messagerie</a></li>
                    <li><a href="#" onclick="showSection('courses')"><i class="fas fa-laptop-code"></i> Cours</a></li>
                    <li><a href="#" onclick="showSection('files')"><i class="fas fa-file-upload"></i> Fichiers</a></li>
                    <li><a href="#" onclick="showSection('profile')"><i class="fas fa-user"></i> Mon profil</a></li>
                </ul>
                <h3 style="margin-top:40px;margin-bottom:20px;color:var(--dark-color);border-bottom:2px solid #e1e8ed;padding-bottom:15px">Mes Classes</h3>
                <ul class="sidebar-menu" id="classesList"></ul>
            </aside>

            <main class="main-content" id="mainContent">
                <!-- Le contenu sera injecté ici dynamiquement -->
            </main>
        </div>
    </div>

    <!-- Modal de création d'administrateur (premier démarrage) -->
    <div id="firstAdminModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-shield"></i> Créer le compte administrateur</h3>
            </div>
            <div class="form-group">
                <label>Nom complet</label>
                <input type="text" id="firstAdminName" placeholder="Nom de l'administrateur" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="firstAdminEmail" placeholder="admin@hanbz.tn" required>
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="firstAdminPassword" placeholder="Mot de passe sécurisé" required minlength="8">
            </div>
            <div class="form-group">
                <label>Confirmer mot de passe</label>
                <input type="password" id="firstAdminPassword2" placeholder="Confirmez le mot de passe" required>
            </div>
            <button class="btn btn-danger" onclick="createFirstAdmin()" style="width:100%">
                Créer l'administrateur
            </button>
            <p style="margin-top:10px;color:#666;font-size:0.9em">
                Ce formulaire apparaît uniquement si aucun administrateur n'existe.
            </p>
        </div>
    </div>

    <script>
        // ====== CONFIGURATION FIREBASE ======
        const firebaseConfig = {
            apiKey: "AIzaSyDKBrdpzMlWqreNl_k1JkM25L3qgEyGTiE",
            authDomain: "hanbz-a34f5.firebaseapp.com",
            projectId: "hanbz-a34f5",
            storageBucket: "hanbz-a34f5.firebasestorage.app",
            messagingSenderId: "48430663923",
            appId: "1:48430663923:web:1a742ac1ad081fedc08f86"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ====== VARIABLES GLOBALES ======
        let users = [];
        let classes = [];
        let files = [];
        let messages = [];
        let currentUser = null;

        // ====== FONCTION D'ALERTE ======
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-toast ${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // ====== CHARGEMENT DES DONNÉES ======
        async function loadData() {
            try {
                console.log('Chargement des données depuis Firebase...');
                
                // Charger les utilisateurs
                const usersSnapshot = await db.collection('users').get();
                users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`${users.length} utilisateurs chargés`);

                // Charger les classes
                const classesSnapshot = await db.collection('classes').get();
                classes = classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`${classes.length} classes chargées`);

                // Charger les fichiers
                const filesSnapshot = await db.collection('files').get();
                files = filesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`${files.length} fichiers chargés`);

                // Charger les messages
                const messagesSnapshot = await db.collection('messages').orderBy('timestamp', 'desc').get();
                messages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`${messages.length} messages chargés`);

            } catch (error) {
                console.error('Erreur chargement données:', error);
                showAlert('Erreur de chargement des données', 'danger');
            }
        }

        // ====== INITIALISATION ======
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
        });

        async function initializeApp() {
            try {
                // Vérifier s'il existe des administrateurs
                const adminSnapshot = await db.collection('users')
                    .where('role', '==', 'admin')
                    .get();
                
                if (adminSnapshot.empty) {
                    console.log('Aucun admin trouvé, affichage du modal');
                    document.getElementById('firstAdminModal').classList.remove('hidden');
                } else {
                    console.log('Admin existe, chargement des données');
                    await loadData();
                }

                // Vérifier l'authentification
                checkAuth();
                
            } catch (error) {
                console.error('Erreur initialisation:', error);
                document.getElementById('firstAdminModal').classList.remove('hidden');
            }
        }

        // ====== CRÉATION DU PREMIER ADMIN ======
        async function createFirstAdmin() {
            const name = document.getElementById('firstAdminName').value.trim();
            const email = document.getElementById('firstAdminEmail').value.trim();
            const password = document.getElementById('firstAdminPassword').value;
            const password2 = document.getElementById('firstAdminPassword2').value;

            if (!name || !email || !password) {
                showAlert('Veuillez remplir tous les champs.', 'danger');
                return;
            }

            if (password.length < 8) {
                showAlert('Le mot de passe doit contenir au moins 8 caractères.', 'danger');
                return;
            }

            if (password !== password2) {
                showAlert('Les mots de passe ne correspondent pas.', 'danger');
                return;
            }

            try {
                showAlert('Création du compte administrateur en cours...', 'warning');

                // Créer l'utilisateur dans Firebase Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Créer le profil dans Firestore
                const adminUser = {
                    id: user.uid,
                    name: name,
                    email: email,
                    role: 'admin',
                    status: 'active',
                    createdAt: new Date().toISOString()
                };

                await db.collection('users').doc(user.uid).set(adminUser);
                
                // Fermer le modal
                document.getElementById('firstAdminModal').classList.add('hidden');
                
                // Réinitialiser les champs
                document.getElementById('firstAdminName').value = '';
                document.getElementById('firstAdminEmail').value = '';
                document.getElementById('firstAdminPassword').value = '';
                document.getElementById('firstAdminPassword2').value = '';

                showAlert('✅ Administrateur créé avec succès ! Vous pouvez maintenant vous connecter.');

            } catch (error) {
                console.error('Erreur création admin:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAlert('Cet email est déjà utilisé.', 'danger');
                } else {
                    showAlert('Erreur lors de la création: ' + error.message, 'danger');
                }
            }
        }

        // ====== AUTHENTIFICATION ======
        function checkAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Utilisateur connecté
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            currentUser = {
                                id: user.uid,
                                name: userData.name,
                                email: userData.email,
                                role: userData.role,
                                status: userData.status
                            };
                            await loadData();
                            showApp();
                            showSection('dashboard');
                            showAlert(`Bienvenue ${userData.name} !`);
                        }
                    } catch (error) {
                        console.error('Erreur chargement profil:', error);
                    }
                } else {
                    // Utilisateur déconnecté
                    currentUser = null;
                    showAuth();
                }
            });
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('Veuillez remplir tous les champs.', 'danger');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // La suite est gérée par onAuthStateChanged
            } catch (error) {
                console.error('Erreur connexion:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showAlert('Email ou mot de passe incorrect.', 'danger');
                } else {
                    showAlert('Erreur de connexion: ' + error.message, 'danger');
                }
            }
        }

        async function registerTeacher() {
            const name = document.getElementById('teacherName').value.trim();
            const email = document.getElementById('teacherEmail').value.trim();
            const password = document.getElementById('teacherPassword').value;
            const specialty = document.getElementById('teacherSpecialty').value.trim();
            
            if (!name || !email || !password || !specialty) {
                showAlert('Veuillez remplir tous les champs.', 'danger');
                return;
            }

            if (password.length < 6) {
                showAlert('Le mot de passe doit contenir au moins 6 caractères.', 'danger');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                const teacherUser = {
                    id: user.uid,
                    name: name,
                    email: email,
                    role: 'teacher',
                    status: 'active',
                    specialty: specialty,
                    createdAt: new Date().toISOString()
                };

                await db.collection('users').doc(user.uid).set(teacherUser);
                
                showAlert('✅ Compte enseignant créé avec succès !');
                showAuthTab('login');
                
                document.getElementById('teacherName').value = '';
                document.getElementById('teacherEmail').value = '';
                document.getElementById('teacherPassword').value = '';
                document.getElementById('teacherSpecialty').value = '';

            } catch (error) {
                console.error('Erreur inscription enseignant:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAlert('Cet email est déjà utilisé.', 'danger');
                } else {
                    showAlert('Erreur lors de l\'inscription: ' + error.message, 'danger');
                }
            }
        }

        async function registerStudent() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const password = document.getElementById('studentPassword').value;
            const studentClass = document.getElementById('studentClass').value;
            
            if (!name || !email || !password || !studentClass) {
                showAlert('Veuillez remplir tous les champs.', 'danger');
                return;
            }

            if (password.length < 6) {
                showAlert('Le mot de passe doit contenir au moins 6 caractères.', 'danger');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                const studentUser = {
                    id: user.uid,
                    name: name,
                    email: email,
                    role: 'student',
                    status: 'pending',
                    class: studentClass,
                    createdAt: new Date().toISOString()
                };

                await db.collection('users').doc(user.uid).set(studentUser);
                
                showAlert('✅ Inscription soumise avec succès. Validation admin requise.');
                showAuthTab('login');
                
                document.getElementById('studentName').value = '';
                document.getElementById('studentEmail').value = '';
                document.getElementById('studentPassword').value = '';
                document.getElementById('studentClass').value = '';

            } catch (error) {
                console.error('Erreur inscription élève:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAlert('Cet email est déjà utilisé.', 'danger');
                } else {
                    showAlert('Erreur lors de l\'inscription: ' + error.message, 'danger');
                }
            }
        }

        function logout() {
            auth.signOut();
        }

        // ====== FONCTIONS D'INTERFACE ======
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('teacherForm').classList.toggle('hidden', tab !== 'teacher');
            document.getElementById('studentForm').classList.toggle('hidden', tab !== 'student');
            
            const tabs = document.querySelectorAll('.auth-tab');
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].textContent.includes(tab === 'login' ? 'Connexion' : tab === 'teacher' ? 'Enseignant' : 'Élève')) {
                    tabs[i].classList.add('active');
                    break;
                }
            }
        }

        function showAuth() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            
            const roleBadge = document.getElementById('userRoleBadge');
            let roleText = '';
            let badgeClass = '';
            
            switch(currentUser.role) {
                case 'teacher':
                    roleText = 'Enseignant';
                    badgeClass = 'badge-teacher';
                    break;
                case 'admin':
                    roleText = 'Administrateur';
                    badgeClass = 'badge-admin';
                    break;
                default:
                    roleText = 'Élève';
                    badgeClass = 'badge-student';
            }
            
            roleBadge.textContent = roleText;
            roleBadge.className = `role-badge ${badgeClass}`;
            
            document.getElementById('teacherMenu').classList.toggle('hidden', !(currentUser.role === 'teacher' || currentUser.role === 'admin'));
            document.getElementById('adminMenu').classList.toggle('hidden', currentUser.role !== 'admin');
            
            updateClassesList();
        }

        function showSection(section) {
            let content = '';
            switch(section) {
                case 'dashboard':
                    content = showDashboard();
                    break;
                case 'students':
                    content = showStudents();
                    break;
                case 'classes':
                    content = showClasses();
                    break;
                case 'pending':
                    content = showPending();
                    break;
                case 'files':
                    content = showFiles();
                    break;
                case 'profile':
                    content = showProfile();
                    break;
                case 'admin':
                    content = showAdmin();
                    break;
                case 'users':
                    content = showUsers();
                    break;
                case 'courses':
                    content = showCourses();
                    break;
                case 'messages':
                    content = showMessages();
                    break;
                default:
                    content = showDashboard();
            }
            document.getElementById('mainContent').innerHTML = content;
            updateActiveNav(section);
        }

        function updateActiveNav(section) {
            document.querySelectorAll('.sidebar-menu a').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar-menu a[onclick*="${section}"]`);
            if (activeLink) activeLink.classList.add('active');
        }

        function showDashboard() {
            const totalStudents = users.filter(u => u.role === 'student' && u.status === 'active').length;
            const totalTeachers = users.filter(u => u.role === 'teacher').length;
            const pendingStudents = users.filter(u => u.role === 'student' && u.status === 'pending').length;
            const userClasses = classes.filter(c => 
                c.students && (c.students.includes(currentUser.id) || c.teacher === currentUser.id)
            );
            
            return `
                <div class="content-header">
                    <h2><i class="fas fa-home"></i> Tableau de bord</h2>
                    <span class="role-badge badge-${currentUser.role}">
                        ${currentUser.role === 'teacher' ? 'Enseignant' : currentUser.role === 'admin' ? 'Administrateur' : 'Élève'}
                    </span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${userClasses.length}</h3>
                        <p><i class="fas fa-laptop-code"></i> Mes classes</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalStudents}</h3>
                        <p><i class="fas fa-user-graduate"></i> Élèves actifs</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalTeachers}</h3>
                        <p><i class="fas fa-chalkboard-teacher"></i> Enseignants</p>
                    </div>
                    <div class="stat-card">
                        <h3>${pendingStudents}</h3>
                        <p><i class="fas fa-clock"></i> En attente</p>
                    </div>
                    <div class="stat-card">
                        <h3>${classes.length}</h3>
                        <p><i class="fas fa-book"></i> Classes créées</p>
                    </div>
                    <div class="stat-card">
                        <h3>${files.length}</h3>
                        <p><i class="fas fa-file"></i> Fichiers partagés</p>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">Activité récente</h3>
                    <div class="alert alert-success">
                        <i class="fas fa-info-circle"></i>
                        Bienvenue sur HanBz.tn, votre plateforme éducative tunisienne.
                        ${currentUser.role === 'admin' ? ' Données synchronisées avec Firebase.' : ''}
                    </div>
                    ${currentUser.status === 'pending' ? `
                        <div class="alert alert-warning">
                            <i class="fas fa-clock"></i>
                            Votre compte est en attente de validation par un administrateur.
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showStudents() {
            if (currentUser.role !== 'teacher' && currentUser.role !== 'admin') {
                return '<p>Accès réservé aux enseignants et administrateurs.</p>';
            }
            
            const activeStudents = users.filter(u => u.role === 'student' && u.status === 'active');
            
            return `
                <div class="content-header">
                    <h2><i class="fas fa-users"></i> Gestion des élèves</h2>
                </div>
                <div class="students-grid">
                    ${activeStudents.map(s => `
                        <div class="student-card">
                            <h4>${s.name}</h4>
                            <p><i class="fas fa-envelope"></i> ${s.email}</p>
                            <p><i class="fas fa-laptop-code"></i> ${s.class || 'Non défini'}</p>
                            <p><small>Inscrit le: ${new Date(s.createdAt).toLocaleDateString('fr-FR')}</small></p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showClasses() {
            if (currentUser.role !== 'teacher' && currentUser.role !== 'admin') {
                return '<p>Accès réservé aux enseignants et administrateurs.</p>';
            }
            
            const teacherClasses = classes.filter(c => c.teacher === currentUser.id || currentUser.role === 'admin');
            
            return `
                <div class="content-header">
                    <h2><i class="fas fa-book"></i> Gestion des classes</h2>
                    <button class="btn btn-primary" onclick="showCreateClassModal()">
                        <i class="fas fa-plus"></i> Créer une classe
                    </button>
                </div>
                <div class="classes-grid">
                    ${teacherClasses.map(c => `
                        <div class="class-card">
                            <h4>${c.name}</h4>
                            <p>${c.description || 'Aucune description'}</p>
                            <p><i class="fas fa-layer-group"></i> ${c.level || 'Tous niveaux'}</p>
                            <p><small><i class="fas fa-user-graduate"></i> ${c.students ? c.students.length : 0} élèves</small></p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="viewClass('${c.id}')">
                                    <i class="fas fa-eye"></i> Voir
                                </button>
                                <button class="btn btn-warning" onclick="editClass('${c.id}')">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showCreateClassModal() {
            document.getElementById('mainContent').innerHTML += `
                <div id="createClassModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-plus"></i> Créer une nouvelle classe</h3>
                            <button onclick="closeModal('createClassModal')" style="background:none;border:none;font-size:1.5em;cursor:pointer">&times;</button>
                        </div>
                        <div class="form-group">
                            <label>Nom de la classe</label>
                            <input type="text" id="className" placeholder="Ex: Programmation Web" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="classDescription" placeholder="Description de la classe..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Niveau</label>
                            <select id="classLevel" required>
                                <option value="">Sélectionnez un niveau</option>
                                <option value="4ème">4ème</option>
                                <option value="3ème">3ème</option>
                                <option value="2ème">2ème</option>
                                <option value="1ère">1ère</option>
                                <option value="Tous niveaux">Tous niveaux</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="createClass()" style="width:100%">
                            <i class="fas fa-save"></i> Créer la classe
                        </button>
                    </div>
                </div>
            `;
        }

        async function createClass() {
            const name = document.getElementById('className').value.trim();
            const description = document.getElementById('classDescription').value.trim();
            const level = document.getElementById('classLevel').value;
            
            if (!name || !level) {
                showAlert('Veuillez remplir le nom et le niveau de la classe.', 'danger');
                return;
            }

            try {
                const classId = Date.now().toString();
                const classData = {
                    id: classId,
                    name: name,
                    description: description,
                    level: level,
                    teacher: currentUser.id,
                    students: [],
                    createdAt: new Date().toISOString()
                };

                await db.collection('classes').doc(classId).set(classData);
                
                await loadData();
                showAlert('Classe créée avec succès !');
                closeModal('createClassModal');
                showSection('classes');
                
            } catch (error) {
                console.error('Erreur création classe:', error);
                showAlert('Erreur lors de la création de la classe: ' + error.message, 'danger');
            }
        }

        function editClass(classId) {
            const classItem = classes.find(c => c.id === classId);
            if (!classItem) return;

            document.getElementById('mainContent').innerHTML += `
                <div id="editClassModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-edit"></i> Modifier la classe</h3>
                            <button onclick="closeModal('editClassModal')" style="background:none;border:none;font-size:1.5em;cursor:pointer">&times;</button>
                        </div>
                        <div class="form-group">
                            <label>Nom de la classe</label>
                            <input type="text" id="editClassName" value="${classItem.name}" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="editClassDescription" rows="3">${classItem.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Niveau</label>
                            <select id="editClassLevel" required>
                                <option value="4ème" ${classItem.level === '4ème' ? 'selected' : ''}>4ème</option>
                                <option value="3ème" ${classItem.level === '3ème' ? 'selected' : ''}>3ème</option>
                                <option value="2ème" ${classItem.level === '2ème' ? 'selected' : ''}>2ème</option>
                                <option value="1ère" ${classItem.level === '1ère' ? 'selected' : ''}>1ère</option>
                                <option value="Tous niveaux" ${classItem.level === 'Tous niveaux' ? 'selected' : ''}>Tous niveaux</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="updateClass('${classId}')" style="width:100%">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                    </div>
                </div>
            `;
        }

        async function updateClass(classId) {
            const name = document.getElementById('editClassName').value.trim();
            const description = document.getElementById('editClassDescription').value.trim();
            const level = document.getElementById('editClassLevel').value;
            
            if (!name || !level) {
                showAlert('Veuillez remplir le nom et le niveau de la classe.', 'danger');
                return;
            }

            try {
                await db.collection('classes').doc(classId).update({
                    name: name,
                    description: description,
                    level: level
                });

                await loadData();
                showAlert('Classe modifiée avec succès !');
                closeModal('editClassModal');
                showSection('classes');
                
            } catch (error) {
                console.error('Erreur modification classe:', error);
                showAlert('Erreur lors de la modification: ' + error.message, 'danger');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
        }

        function showPending() {
            if (currentUser.role !== 'teacher' && currentUser.role !== 'admin') {
                return '<p>Accès réservé aux enseignants et administrateurs.</p>';
            }
            
            const pending = users.filter(u => u.role === 'student' && u.status === 'pending');
            
            return `
                <div class="content-header">
                    <h2><i class="fas fa-user-check"></i> Validations (${pending.length})</h2>
                </div>
                ${pending.length === 0 ? 
                    '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Aucune demande d\'inscription en attente.</div>' :
                    pending.map(p => `
                        <div style="background: white; padding: 20px; margin: 15px 0; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${p.name}</strong><br>
                                    <i class="fas fa-envelope"></i> ${p.email}<br>
                                    <i class="fas fa-laptop-code"></i> ${p.class || 'Non spécifié'}<br>
                                    <small>Inscrit le: ${new Date(p.createdAt).toLocaleDateString('fr-FR')}</small>
                                </div>
                                <div>
                                    <button class="btn btn-success" onclick="approveStudent('${p.id}')">
                                        <i class="fas fa-check"></i> Approuver
                                    </button>
                                    <button class="btn btn-warning" onclick="rejectStudent('${p.id}')">
                                        <i class="fas fa-times"></i> Refuser
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')
                }
            `;
        }

        async function approveStudent(studentId) {
            try {
                await db.collection('users').doc(studentId).update({
                    status: 'active'
                });
                
                await loadData();
                showAlert('Élève approuvé avec succès.');
                showSection('pending');
            } catch (error) {
                console.error('Erreur approbation:', error);
                showAlert('Erreur lors de l\'approbation', 'danger');
            }
        }

        async function rejectStudent(studentId) {
            if (confirm('Êtes-vous sûr de vouloir refuser cette inscription ?')) {
                try {
                    // Supprimer l'utilisateur Firestore
                    await db.collection('users').doc(studentId).delete();
                    
                    await loadData();
                    showAlert('Inscription refusée.');
                    showSection('pending');
                } catch (error) {
                    console.error('Erreur rejet:', error);
                    showAlert('Erreur lors du rejet', 'danger');
                }
            }
        }

        // ====== GESTION DES FICHIERS - CORRIGÉE ======
        function showFiles() {
            const getFileIcon = (fileName) => {
                const ext = fileName.split('.').pop().toLowerCase();
                if (['pdf'].includes(ext)) return 'fa-file-pdf';
                if (['doc', 'docx'].includes(ext)) return 'fa-file-word';
                if (['xls', 'xlsx'].includes(ext)) return 'fa-file-excel';
                if (['ppt', 'pptx'].includes(ext)) return 'fa-file-powerpoint';
                if (['zip', 'rar', '7z'].includes(ext)) return 'fa-file-archive';
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) return 'fa-file-image';
                return 'fa-file';
            };

            const getFileColor = (fileName) => {
                const ext = fileName.split('.').pop().toLowerCase();
                if (['pdf'].includes(ext)) return '#e74c3c';
                if (['doc', 'docx'].includes(ext)) return '#2c5aa0';
                if (['xls', 'xlsx'].includes(ext)) return '#1d6f42';
                if (['ppt', 'pptx'].includes(ext)) return '#d35400';
                return '#3498db';
            };

            return `
                <div class="content-header">
                    <h2><i class="fas fa-file-upload"></i> Fichiers partagés (${files.length})</h2>
                    ${(currentUser.role === 'teacher' || currentUser.role === 'admin') ? 
                        `<button class="btn btn-primary" onclick="showUploadModal()">
                            <i class="fas fa-upload"></i> Uploader un fichier
                        </button>` : ''
                    }
                </div>
                <div style="padding: 20px; background: #f8f9fa; border-radius: var(--border-radius);">
                    ${files.length === 0 ? 
                        '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Aucun fichier partagé pour le moment.</div>' :
                        files.map(f => `
                            <div class="file-item">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas ${getFileIcon(f.name)}" style="color: ${getFileColor(f.name)}; font-size: 1.5em;"></i>
                                    <div>
                                        <strong>${f.name}</strong><br>
                                        <span style="color: #666; font-size: 0.9em;">
                                            ${f.size || 'Taille inconnue'} • 
                                            Uploadé le ${f.uploadDate ? new Date(f.uploadDate).toLocaleDateString('fr-FR') : 'Date inconnue'}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="downloadFile('${f.id}')">
                                        <i class="fas fa-download"></i> Télécharger
                                    </button>
                                    ${(currentUser.role === 'teacher' || currentUser.role === 'admin') ? `
                                        <button class="btn btn-danger" onclick="deleteFile('${f.id}')" style="margin-left: 10px;">
                                            <i class="fas fa-trash"></i> Supprimer
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }

        function showUploadModal() {
            document.getElementById('mainContent').innerHTML += `
                <div id="uploadModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-upload"></i> Uploader un fichier</h3>
                            <button onclick="closeModal('uploadModal')" style="background:none;border:none;font-size:1.5em;cursor:pointer">&times;</button>
                        </div>
                        <div class="form-group">
                            <label>Sélectionner un fichier</label>
                            <input type="file" id="fileInput" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Nom du fichier (optionnel)</label>
                            <input type="text" id="fileName" placeholder="Laisser vide pour utiliser le nom original">
                        </div>
                        <button class="btn btn-success" onclick="uploadFile()" style="width:100%">
                            <i class="fas fa-upload"></i> Uploader
                        </button>
                        <div id="uploadProgress" style="margin-top:15px;display:none">
                            <div class="progress-bar">
                                <div id="progressBar" class="progress-fill"></div>
                            </div>
                            <div id="progressText" style="text-align:center;margin-top:5px">0%</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const fileNameInput = document.getElementById('fileName');
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (!fileInput.files[0]) {
                showAlert('Veuillez sélectionner un fichier', 'danger');
                return;
            }

            const file = fileInput.files[0];
            const fileName = fileNameInput.value.trim() || file.name;
            
            try {
                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                
                console.log('Début upload:', fileName, 'Taille:', file.size);
                
                // Créer une référence pour le fichier avec un nom unique
                const fileId = Date.now().toString();
                const storageRef = firebase.storage().ref();
                const fileRef = storageRef.child(`files/${fileId}_${fileName}`);
                
                // Uploader le fichier
                const uploadTask = fileRef.put(file);
                
                // Suivre la progression
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Progression de l'upload
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Progression upload:', progress + '%');
                        progressBar.style.width = progress + '%';
                        progressText.textContent = Math.round(progress) + '%';
                    },
                    (error) => {
                        console.error('Erreur upload:', error);
                        showAlert('Erreur lors de l\'upload: ' + error.message, 'danger');
                        progressDiv.style.display = 'none';
                    },
                    async () => {
                        try {
                            // Upload réussi
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            console.log('URL de téléchargement:', downloadURL);
                            
                            const fileData = {
                                id: fileId,
                                name: fileName,
                                size: (file.size / (1024 * 1024)).toFixed(2) + ' MB',
                                uploadDate: new Date().toISOString(),
                                uploadedBy: currentUser.id,
                                url: downloadURL,
                                originalName: file.name
                            };
                            
                            // Sauvegarder les métadonnées dans Firestore
                            await db.collection('files').doc(fileId).set(fileData);
                            
                            // Recharger les données
                            await loadData();
                            
                            showAlert('Fichier uploadé avec succès !');
                            closeModal('uploadModal');
                            showSection('files');
                            
                        } catch (error) {
                            console.error('Erreur sauvegarde métadonnées:', error);
                            showAlert('Erreur lors de la sauvegarde: ' + error.message, 'danger');
                        }
                    }
                );
                
            } catch (error) {
                console.error('Erreur upload:', error);
                showAlert('Erreur lors de l\'upload: ' + error.message, 'danger');
                progressDiv.style.display = 'none';
            }
        }

        async function downloadFile(fileId) {
            try {
                const file = files.find(f => f.id === fileId);
                if (!file) {
                    showAlert('Fichier non trouvé', 'danger');
                    return;
                }

                showAlert(`Téléchargement de "${file.name}" en cours...`, 'warning');

                // Essayer d'abord avec l'URL stockée
                if (file.url) {
                    const a = document.createElement('a');
                    a.href = file.url;
                    a.download = file.name;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showAlert(`"${file.name}" téléchargé avec succès !`);
                    return;
                }

                // Fallback: récupérer depuis Storage
                const storageRef = firebase.storage().ref();
                const fileRef = storageRef.child(`files/${fileId}_${file.name}`);
                
                try {
                    const url = await fileRef.getDownloadURL();
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showAlert(`"${file.name}" téléchargé avec succès !`);
                } catch (storageError) {
                    console.error('Erreur storage:', storageError);
                    showAlert('Erreur: Fichier introuvable dans le stockage', 'danger');
                }
                
            } catch (error) {
                console.error('Erreur téléchargement:', error);
                showAlert('Erreur lors du téléchargement: ' + error.message, 'danger');
            }
        }

        async function deleteFile(fileId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce fichier ?')) {
                try {
                    const file = files.find(f => f.id === fileId);
                    
                    // Supprimer de Firestore
                    await db.collection('files').doc(fileId).delete();
                    
                    // Supprimer de Storage
                    if (file) {
                        const storageRef = firebase.storage().ref();
                        const fileRef = storageRef.child(`files/${fileId}_${file.name}`);
                        await fileRef.delete();
                    }
                    
                    await loadData();
                    showAlert('Fichier supprimé avec succès');
                    showSection('files');
                } catch (error) {
                    console.error('Erreur suppression fichier:', error);
                    showAlert('Erreur lors de la suppression', 'danger');
                }
            }
        }

        // ====== GESTION DES COURS ======
        function showCourses() {
            const canCreate = currentUser.role === 'teacher' || currentUser.role === 'admin';
            const userCourses = currentUser.role === 'student' 
                ? classes.filter(c => c.students && c.students.includes(currentUser.id))
                : classes;
            
            return `
                <div class="content-header">
                    <h2><i class="fas fa-laptop-code"></i> Cours disponibles</h2>
                    ${canCreate ? `
                        <button class="btn btn-primary" onclick="showCreateCourseModal()">
                            <i class="fas fa-plus"></i> Créer un cours
                        </button>
                    ` : ''}
                </div>
                
                ${currentUser.role === 'student' ? `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Voici les cours auxquels vous êtes inscrit.
                    </div>
                ` : ''}
                
                <div class="classes-grid">
                    ${userCourses.length === 0 ? 
                        '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Aucun cours disponible pour le moment.</div>' :
                        userCourses.map(course => `
                            <div class="class-card">
                                <h4>${course.name}</h4>
                                <p>${course.description || 'Aucune description'}</p>
                                <p><i class="fas fa-layer-group"></i> ${course.level || 'Tous niveaux'}</p>
                                <p><small><i class="fas fa-user-graduate"></i> ${course.students ? course.students.length : 0} élèves</small></p>
                                <p><small><i class="fas fa-chalkboard-teacher"></i> ${getTeacherName(course.teacher)}</small></p>
                                <button class="btn btn-primary" style="margin-top: 10px;" onclick="viewCourse('${course.id}')">
                                    <i class="fas fa-eye"></i> Voir le cours
                                </button>
                                ${(currentUser.role === 'teacher' || currentUser.role === 'admin') && course.teacher === currentUser.id ? `
                                    <button class="btn btn-warning" style="margin-top: 5px;" onclick="editCourse('${course.id}')">
                                        <i class="fas fa-edit"></i> Modifier
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }

        function getTeacherName(teacherId) {
            const teacher = users.find(u => u.id === teacherId);
            return teacher ? teacher.name : 'Inconnu';
        }

        function showCreateCourseModal() {
            document.getElementById('mainContent').innerHTML += `
                <div id="createCourseModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-plus"></i> Créer un nouveau cours</h3>
                            <button onclick="closeModal('createCourseModal')" style="background:none;border:none;font-size:1.5em;cursor:pointer">&times;</button>
                        </div>
                        <div class="form-group">
                            <label>Nom du cours</label>
                            <input type="text" id="courseName" placeholder="Ex: Programmation Web" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="courseDescription" placeholder="Description du cours..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Niveau</label>
                            <select id="courseLevel" required>
                                <option value="">Sélectionnez un niveau</option>
                                <option value="4ème">4ème</option>
                                <option value="3ème">3ème</option>
                                <option value="2ème">2ème</option>
                                <option value="1ère">1ère</option>
                                <option value="Tous niveaux">Tous niveaux</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="createCourse()" style="width:100%">
                            <i class="fas fa-save"></i> Créer le cours
                        </button>
                    </div>
                </div>
            `;
        }

        async function createCourse() {
            const name = document.getElementById('courseName').value.trim();
            const description = document.getElementById('courseDescription').value.trim();
            const level = document.getElementById('courseLevel').value;
            
            if (!name || !level) {
                showAlert('Veuillez remplir le nom et le niveau du cours.', 'danger');
                return;
            }

            try {
                const courseId = Date.now().toString();
                const courseData = {
                    id: courseId,
                    name: name,
                    description: description,
                    level: level,
                    teacher: currentUser.id,
                    students: [],
                    createdAt: new Date().toISOString()
                };

                await db.collection('classes').doc(courseId).set(courseData);
                
                await loadData();
                showAlert('Cours créé avec succès !');
                closeModal('createCourseModal');
                showSection('courses');
                
            } catch (error) {
                console.error('Erreur création cours:', error);
                showAlert('Erreur lors de la création du cours: ' + error.message, 'danger');
            }
        }

        function viewCourse(courseId) {
            const course = classes.find(c => c.id === courseId);
            if (!course) {
                showAlert('Cours non trouvé', 'danger');
                return;
            }

            const teacher = users.find(u => u.id === course.teacher);
            const isEnrolled = course.students && course.students.includes(currentUser.id);
            const isTeacher = course.teacher === currentUser.id;
            
            document.getElementById('mainContent').innerHTML = `
                <div class="content-header">
                    <h2>${course.name}</h2>
                    <div>
                        ${currentUser.role === 'student' && !isEnrolled ? `
                            <button class="btn btn-success" onclick="enrollInCourse('${course.id}')">
                                <i class="fas fa-user-plus"></i> S'inscrire
                            </button>
                        ` : ''}
                        ${isTeacher ? `
                            <button class="btn btn-warning" onclick="editCourse('${course.id}')">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                        <div>
                            <h3><i class="fas fa-info-circle"></i> Description</h3>
                            <p>${course.description || 'Aucune description disponible.'}</p>
                            
                            <h3 style="margin-top: 30px;"><i class="fas fa-list"></i> Contenu du cours</h3>
                            <div class="course-content">
                                <h4>Leçons disponibles</h4>
                                ${generateLessonItems()}
                            </div>
                        </div>
                        
                        <div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: var(--border-radius);">
                                <h4><i class="fas fa-chalkboard-teacher"></i> Enseignant</h4>
                                <p>${teacher ? teacher.name : 'Inconnu'}</p>
                                
                                <h4 style="margin-top: 20px;"><i class="fas fa-layer-group"></i> Niveau</h4>
                                <p>${course.level || 'Non spécifié'}</p>
                                
                                <h4 style="margin-top: 20px;"><i class="fas fa-user-graduate"></i> Élèves inscrits</h4>
                                <p>${course.students ? course.students.length : 0} élèves</p>
                                
                                ${isEnrolled ? `
                                    <div class="alert alert-success" style="margin-top: 15px;">
                                        <i class="fas fa-check-circle"></i> Vous êtes inscrit à ce cours
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateLessonItems() {
            const lessons = [
                { title: 'Introduction au cours', duration: '30 min', completed: true },
                { title: 'Les bases fondamentales', duration: '45 min', completed: true },
                { title: 'Concepts avancés', duration: '60 min', completed: false },
                { title: 'Exercices pratiques', duration: '90 min', completed: false },
                { title: 'Projet final', duration: '120 min', completed: false }
            ];

            return lessons.map(lesson => `
                <div class="lesson-item">
                    <div>
                        <strong>${lesson.title}</strong>
                        <br><small>Durée: ${lesson.duration}</small>
                    </div>
                    <div>
                        ${lesson.completed ? 
                            '<span style="color: var(--success-color);"><i class="fas fa-check-circle"></i> Terminé</span>' :
                            '<span style="color: var(--warning-color);"><i class="fas fa-play-circle"></i> À commencer</span>'
                        }
                    </div>
                </div>
            `).join('');
        }

        async function enrollInCourse(courseId) {
            try {
                const course = classes.find(c => c.id === courseId);
                if (!course) {
                    showAlert('Cours non trouvé', 'danger');
                    return;
                }

                // Vérifier si déjà inscrit
                if (course.students && course.students.includes(currentUser.id)) {
                    showAlert('Vous êtes déjà inscrit à ce cours', 'warning');
                    return;
                }

                // Mettre à jour la liste des étudiants
                const updatedStudents = course.students ? [...course.students, currentUser.id] : [currentUser.id];
                
                await db.collection('classes').doc(courseId).update({
                    students: updatedStudents
                });

                await loadData();
                showAlert('Inscription au cours réussie !');
                viewCourse(courseId);
                
            } catch (error) {
                console.error('Erreur inscription cours:', error);
                showAlert('Erreur lors de l\'inscription: ' + error.message, 'danger');
            }
        }

        function editCourse(courseId) {
            const course = classes.find(c => c.id === courseId);
            if (!course) return;

            document.getElementById('mainContent').innerHTML += `
                <div id="editCourseModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-edit"></i> Modifier le cours</h3>
                            <button onclick="closeModal('editCourseModal')" style="background:none;border:none;font-size:1.5em;cursor:pointer">&times;</button>
                        </div>
                        <div class="form-group">
                            <label>Nom du cours</label>
                            <input type="text" id="editCourseName" value="${course.name}" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="editCourseDescription" rows="3">${course.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Niveau</label>
                            <select id="editCourseLevel" required>
                                <option value="4ème" ${course.level === '4ème' ? 'selected' : ''}>4ème</option>
                                <option value="3ème" ${course.level === '3ème' ? 'selected' : ''}>3ème</option>
                                <option value="2ème" ${course.level === '2ème' ? 'selected' : ''}>2ème</option>
                                <option value="1ère" ${course.level === '1ère' ? 'selected' : ''}>1ère</option>
                                <option value="Tous niveaux" ${course.level === 'Tous niveaux' ? 'selected' : ''}>Tous niveaux</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="updateCourse('${courseId}')" style="width:100%">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                    </div>
                </div>
            `;
        }

        async function updateCourse(courseId) {
            const name = document.getElementById('editCourseName').value.trim();
            const description = document.getElementById('editCourseDescription').value.trim();
            const level = document.getElementById('editCourseLevel').value;
            
            if (!name || !level) {
                showAlert('Veuillez remplir le nom et le niveau du cours.', 'danger');
                return;
            }

            try {
                await db.collection('classes').doc(courseId).update({
                    name: name,
                    description: description,
                    level: level
                });

                await loadData();
                showAlert('Cours modifié avec succès !');
                closeModal('editCourseModal');
                viewCourse(courseId);
                
            } catch (error) {
                console.error('Erreur modification cours:', error);
                showAlert('Erreur lors de la modification: ' + error.message, 'danger');
            }
        }

        // ====== MESSAGERIE ======
        function showMessages() {
            const userMessages = messages.filter(m => 
                m.to === currentUser.id || m.from === currentUser.id
            );

            return `
                <div class="content-header">
                    <h2><i class="fas fa-comments"></i> Messagerie</h2>
                    <button class="btn btn-primary" onclick="showNewMessageModal()">
                        <i class="fas fa-plus"></i> Nouveau message
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                        <h4><i class="fas fa-inbox"></i> Boîte de réception</h4>
                        <p>${userMessages.length} message(s)</p>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                        <h4><i class="fas fa-envelope"></i> Messages récents</h4>
                        ${userMessages.length === 0 ? 
                            '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Aucun message pour le moment.</div>' :
                            userMessages.slice(0, 5).map(msg => `
                                <div class="message-item">
                                    <div class="message-header">
                                        <span class="message-sender">${getUserName(msg.from)}</span>
                                        <span class="message-time">${new Date(msg.timestamp).toLocaleDateString('fr-FR')}</span>
                                    </div>
                                    <p>${msg.content}</p>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }

        function getUserName(userId) {
            const user = users.find(u => u.id === userId);
            return user ? user.name : 'Utilisateur inconnu';
        }

        function showNewMessageModal() {
            const recipients = users.filter(u => u.id !== currentUser.id);
            
            document.getElementById('mainContent').innerHTML += `
                <div id="newMessageModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-envelope"></i> Nouveau message</h3>
                            <button onclick="closeModal('newMessageModal')" style="background:none;border:none;font-size:1.5em;cursor:pointer">&times;</button>
                        </div>
                        <div class="form-group">
                            <label>Destinataire</label>
                            <select id="messageTo" required>
                                <option value="">Sélectionnez un destinataire</option>
                                ${recipients.map(user => `
                                    <option value="${user.id}">${user.name} (${user.role})</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Message</label>
                            <textarea id="messageContent" rows="5" placeholder="Tapez votre message ici..." required></textarea>
                        </div>
                        <button class="btn btn-success" onclick="sendMessage()" style="width:100%">
                            <i class="fas fa-paper-plane"></i> Envoyer le message
                        </button>
                    </div>
                </div>
            `;
        }

        async function sendMessage() {
            const to = document.getElementById('messageTo').value;
            const content = document.getElementById('messageContent').value.trim();
            
            if (!to || !content) {
                showAlert('Veuillez remplir tous les champs.', 'danger');
                return;
            }

            try {
                const messageId = Date.now().toString();
                const messageData = {
                    id: messageId,
                    from: currentUser.id,
                    to: to,
                    content: content,
                    timestamp: new Date().toISOString(),
                    read: false
                };

                await db.collection('messages').doc(messageId).set(messageData);
                
                await loadData();
                showAlert('Message envoyé avec succès !');
                closeModal('newMessageModal');
                showSection('messages');
                
            } catch (error) {
                console.error('Erreur envoi message:', error);
                showAlert('Erreur lors de l\'envoi du message: ' + error.message, 'danger');
            }
        }

        // ====== PROFIL ======
        function showProfile() {
            const userClasses = classes.filter(c => 
                c.students && (c.students.includes(currentUser.id) || c.teacher === currentUser.id)
            );
            
            return `
                <div class="content-header">
                    <h2><i class="fas fa-user"></i> Mon profil</h2>
                </div>
                <div style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px;">
                            <i class="fas fa-user" style="color: white; font-size: 2em;"></i>
                        </div>
                        <div>
                            <h3>${currentUser.name}</h3>
                            <p><i class="fas fa-envelope"></i> ${currentUser.email}</p>
                            <span class="role-badge badge-${currentUser.role}">
                                ${currentUser.role === 'teacher' ? 'Enseignant' : currentUser.role === 'admin' ? 'Administrateur' : 'Élève'}
                            </span>
                            ${currentUser.status === 'pending' ? `
                                <span style="background: var(--warning-color); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; margin-left: 10px;">
                                    En attente de validation
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: var(--border-radius);">
                            <h4><i class="fas fa-info-circle"></i> Informations</h4>
                            <p>Membre depuis: ${new Date().toLocaleDateString('fr-FR')}</p>
                            ${currentUser.specialty ? `<p>Spécialité: ${currentUser.specialty}</p>` : ''}
                            ${currentUser.class ? `<p>Classe: ${currentUser.class}</p>` : ''}
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: var(--border-radius);">
                            <h4><i class="fas fa-chart-bar"></i> Statistiques</h4>
                            <p>Classes: ${userClasses.length}</p>
                            <p>Messages: ${messages.filter(m => m.from === currentUser.id).length}</p>
                            <p>Fichiers: ${files.filter(f => f.uploadedBy === currentUser.id).length}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ====== ADMINISTRATION ======
        function showAdmin() {
            if (currentUser.role !== 'admin') {
                return '<p>Accès réservé aux administrateurs.</p>';
            }

            return `
                <div class="content-header">
                    <h2><i class="fas fa-cogs"></i> Administration</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${users.length}</h3>
                        <p>Utilisateurs totaux</p>
                    </div>
                    <div class="stat-card">
                        <h3>${files.length}</h3>
                        <p>Fichiers stockés</p>
                    </div>
                    <div class="stat-card">
                        <h3>${classes.length}</h3>
                        <p>Classes créées</p>
                    </div>
                    <div class="stat-card">
                        <h3>${messages.length}</h3>
                        <p>Messages échangés</p>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <h3>Actions administratives</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <button class="btn btn-danger" onclick="showSection('users')">
                            <i class="fas fa-user-cog"></i> Gérer utilisateurs
                        </button>
                        <button class="btn btn-warning" onclick="showSection('files')">
                            <i class="fas fa-file"></i> Gérer fichiers
                        </button>
                        <button class="btn btn-primary" onclick="showSection('classes')">
                            <i class="fas fa-book"></i> Gérer classes
                        </button>
                    </div>
                </div>
            `;
        }

        function showUsers() {
            if (currentUser.role !== 'admin') {
                return '<p>Accès réservé aux administrateurs.</p>';
            }

            return `
                <div class="content-header">
                    <h2><i class="fas fa-user-cog"></i> Gestion des utilisateurs</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e1e8ed;">Nom</th>
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e1e8ed;">Email</th>
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e1e8ed;">Rôle</th>
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e1e8ed;">Statut</th>
                                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e1e8ed;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td style="padding: 15px; border-bottom: 1px solid #e1e8ed;">${user.name}</td>
                                    <td style="padding: 15px; border-bottom: 1px solid #e1e8ed;">${user.email}</td>
                                    <td style="padding: 15px; border-bottom: 1px solid #e1e8ed;">
                                        <span class="role-badge badge-${user.role}">
                                            ${user.role === 'teacher' ? 'Enseignant' : user.role === 'admin' ? 'Administrateur' : 'Élève'}
                                        </span>
                                    </td>
                                    <td style="padding: 15px; border-bottom: 1px solid #e1e8ed;">
                                        <span style="color: ${user.status === 'active' ? 'green' : 'orange'};">
                                            ${user.status === 'active' ? 'Actif' : 'En attente'}
                                        </span>
                                    </td>
                                    <td style="padding: 15px; border-bottom: 1px solid #e1e8ed;">
                                        ${user.role !== 'admin' ? `
                                            <button class="btn btn-warning" onclick="deleteUser('${user.id}')">
                                                <i class="fas fa-trash"></i> Supprimer
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function deleteUser(userId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
                try {
                    await db.collection('users').doc(userId).delete();
                    await loadData();
                    showAlert('Utilisateur supprimé avec succès');
                    showSection('users');
                } catch (error) {
                    console.error('Erreur suppression:', error);
                    showAlert('Erreur lors de la suppression', 'danger');
                }
            }
        }

        function updateClassesList() {
            const classesList = document.getElementById('classesList');
            const userClasses = classes.filter(c => 
                c.students && (c.students.includes(currentUser.id) || c.teacher === currentUser.id)
            );
            
            classesList.innerHTML = userClasses.length === 0 ? 
                '<li><a href="#"><i class="fas fa-info-circle"></i> Aucune classe</a></li>' :
                userClasses.map(c => `
                    <li><a href="#" onclick="viewClass('${c.id}')">
                        <i class="fas fa-laptop-code"></i> ${c.name}
                    </a></li>
                `).join('');
        }

        function viewClass(classId) {
            const classItem = classes.find(x => x.id === classId);
            if (!classItem) return;
            
            const teacher = users.find(u => u.id === classItem.teacher);
            const studentList = classItem.students ? classItem.students.map(studentId => {
                const student = users.find(u => u.id === studentId);
                return student ? student.name : 'Élève inconnu';
            }) : [];
            
            document.getElementById('mainContent').innerHTML = `
                <div class="content-header">
                    <h2>${classItem.name}</h2>
                </div>
                <div style="background: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                    <p><strong>Description:</strong> ${classItem.description || 'Aucune description'}</p>
                    <p><strong>Niveau:</strong> ${classItem.level || 'Tous niveaux'}</p>
                    <p><strong>Enseignant:</strong> ${teacher ? teacher.name : 'Inconnu'}</p>
                    
                    <div style="margin-top: 20px;">
                        <h4><i class="fas fa-user-graduate"></i> Élèves inscrits (${studentList.length})</h4>
                        <div style="margin-top: 10px;">
                            ${studentList.length === 0 ? 
                                '<p>Aucun élève inscrit.</p>' :
                                studentList.map(student => `
                                    <div style="padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: var(--border-radius);">
                                        ${student}
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // Fermer les modals en cliquant à l'extérieur
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
</body>
</html>